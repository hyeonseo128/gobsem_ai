<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³±ì…ˆê³µì‹ í•™ìŠµ í”„ë¡œê·¸ë¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            color: #ecf0f1;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            background-color: #34495e;
            color: #ecf0f1;
            border: 2px solid #4a5f7f;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background-color: #4a5f7f;
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background-color: #5a7fa7;
            border-color: #7fa7d7;
        }

        .game-area, .ai-area {
            display: none;
            background-color: #34495e;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .game-area.active, .ai-area.active {
            display: block;
        }

        .problem-display {
            background-color: #2c3e50;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8em;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .problem-display.correct {
            background-color: #27ae60;
            animation: pulse-success 0.5s ease;
        }

        .problem-display.wrong {
            background-color: #c0392b;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 2px solid #4a5f7f;
            border-radius: 6px;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #7fa7d7;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1em;
            background-color: #5a7fa7;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #7fa7d7;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background-color: #4a5f7f;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-size: 1.1em;
            display: none;
        }

        .feedback.correct {
            background-color: #27ae60;
            display: block;
        }

        .feedback.wrong {
            background-color: #c0392b;
            display: block;
        }

        .score {
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .timer-display {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #3498db;
            font-weight: bold;
        }

        .timer-display.warning {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .result-screen {
            display: none;
            background-color: #34495e;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
        }

        .result-screen.active {
            display: block;
        }

        .result-screen h2 {
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #3498db;
        }

        .result-stats {
            font-size: 1.5em;
            margin-bottom: 30px;
        }

        .leaderboard {
            background-color: #2c3e50;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .leaderboard h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #3498db;
        }

        .leaderboard-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #34495e;
            border-radius: 5px;
            font-size: 1.2em;
        }

        .leaderboard-item.current {
            border: 2px solid #3498db;
        }

        .ai-comment {
            background-color: #2c3e50;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 80px;
            font-size: 1.05em;
            line-height: 1.6;
        }

        .ai-comment.loading {
            opacity: 0.6;
        }

        .difficulty-selector {
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .math-keyboard {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background-color: #2c3e50;
            border-radius: 8px;
        }

        .keyboard-section {
            display: grid;
            gap: 8px;
        }

        .keyboard-section.variables {
            grid-template-columns: repeat(3, 1fr);
        }

        .keyboard-section.operators {
            grid-template-columns: repeat(2, 1fr);
        }

        .keyboard-section.numbers {
            grid-template-columns: repeat(3, 1fr);
        }

        .keyboard-section.special {
            grid-template-columns: repeat(2, 1fr);
        }

        .math-key {
            padding: 15px;
            font-size: 1.3em;
            color: #ecf0f1;
            border: 2px solid #4a5f7f;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .math-key:hover {
            transform: scale(1.05);
        }

        .math-key:active {
            transform: scale(0.95);
        }

        /* ë³€ìˆ˜ í‚¤ - ë³´ë¼ìƒ‰ */
        .math-key.var {
            background-color: #8e44ad;
            border-color: #9b59b6;
        }

        .math-key.var:hover {
            background-color: #9b59b6;
        }

        /* ì—°ì‚°ì í‚¤ - ì£¼í™©ìƒ‰ */
        .math-key.op {
            background-color: #d35400;
            border-color: #e67e22;
        }

        .math-key.op:hover {
            background-color: #e67e22;
        }

        /* ìˆ«ì í‚¤ - íŒŒë€ìƒ‰ */
        .math-key.num {
            background-color: #2980b9;
            border-color: #3498db;
        }

        .math-key.num:hover {
            background-color: #3498db;
        }

        /* íŠ¹ìˆ˜ í‚¤ - íšŒìƒ‰ */
        .math-key.special {
            background-color: #34495e;
            border-color: #4a5f7f;
        }

        .math-key.special:hover {
            background-color: #4a5f7f;
        }

        .math-key.wide {
            grid-column: span 2;
        }

        .start-screen {
            background-color: #34495e;
            padding: 60px 40px;
            border-radius: 12px;
            text-align: center;
        }

        .start-screen h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #3498db;
        }

        .start-screen p {
            font-size: 1.3em;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .start-btn {
            padding: 20px 50px;
            font-size: 1.5em;
            background-color: #3498db;
            color: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .start-btn:hover {
            background-color: #5dade2;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ê³±ì…ˆê³µì‹ í•™ìŠµ í”„ë¡œê·¸ë¨</h1>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('game')">ê³±ì…ˆê³µì‹ ê²Œì„</button>
            <button class="mode-btn" onclick="switchMode('ai')">AI ë¬¸ì œ í’€ì´</button>
        </div>

        <!-- ê²Œì„ ëª¨ë“œ -->
        <div class="game-area active">
            <!-- ì‹œì‘ í™”ë©´ -->
            <div class="start-screen" id="startScreen">
                <h2>ê³±ì…ˆê³µì‹ ê²Œì„</h2>
                <p>60ì´ˆ ì•ˆì— ìµœëŒ€í•œ ë§ì€ ë¬¸ì œë¥¼ ë§ì¶°ë³´ì„¸ìš”!</p>
                <button class="start-btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
            </div>

            <!-- ê²Œì„ í™”ë©´ -->
            <div id="gameScreen" class="hidden">
                <div class="timer-display" id="timerDisplay">
                    ë‚¨ì€ ì‹œê°„: <span id="timeLeft">60</span>ì´ˆ
                </div>
                
                <div class="score">
                    ì •ë‹µ: <span id="correctCount">0</span> | ì˜¤ë‹µ: <span id="wrongCount">0</span>
                </div>
                
                <div class="problem-display" id="problemDisplay">
                    ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                </div>

                <div class="input-group">
                    <label for="answerInput">ì •ë‹µ ì…ë ¥:</label>
                    <input type="text" id="answerInput" placeholder="ì˜ˆ: (x+3)(x-3) ë˜ëŠ” xÂ²-9">
                </div>

                <!-- ìˆ˜í•™ í‚¤ë³´ë“œ -->
                <div class="math-keyboard">
                    <!-- ë³€ìˆ˜ ì„¹ì…˜ -->
                    <div class="keyboard-section variables">
                        <button class="math-key var" onclick="insertMath('a')">a</button>
                        <button class="math-key var" onclick="insertMath('b')">b</button>
                        <button class="math-key var" onclick="insertMath('c')">c</button>
                        <button class="math-key var" onclick="insertMath('d')">d</button>
                        <button class="math-key var" onclick="insertMath('m')">m</button>
                        <button class="math-key var" onclick="insertMath('n')">n</button>
                        <button class="math-key var" onclick="insertMath('x')">x</button>
                        <button class="math-key var" onclick="insertMath('y')">y</button>
                        <button class="math-key var" onclick="insertMath('z')">z</button>
                    </div>

                    <!-- íŠ¹ìˆ˜ ê¸°í˜¸ ì„¹ì…˜ -->
                    <div class="keyboard-section special">
                        <button class="math-key special" onclick="insertMath('Â²')">xÂ²</button>
                        <button class="math-key special" onclick="insertMath('Â³')">xÂ³</button>
                        <button class="math-key special" onclick="insertMath('â´')">xâ´</button>
                        <button class="math-key special" onclick="insertMath('(')">(</button>
                        <button class="math-key special" onclick="insertMath(')')">)</button>
                        <button class="math-key special" onclick="insertMath('{')">{</button>
                        <button class="math-key special" onclick="insertMath('}')">}</button>
                        <button class="math-key special wide" onclick="backspaceMath()">âŒ« ì§€ìš°ê¸°</button>
                    </div>

                    <!-- ì—°ì‚°ì ì„¹ì…˜ -->
                    <div class="keyboard-section operators">
                        <button class="math-key op" onclick="insertMath('+')">+</button>
                        <button class="math-key op" onclick="insertMath('-')">-</button>
                        <button class="math-key op" onclick="insertMath('Ã—')">Ã—</button>
                        <button class="math-key op" onclick="insertMath('Ã·')">Ã·</button>
                        <button class="math-key op" onclick="insertMath('=')">=</button>
                        <button class="math-key op" onclick="insertMath('â‰ ')">â‰ </button>
                    </div>

                    <!-- ìˆ«ì í‚¤íŒ¨ë“œ -->
                    <div class="keyboard-section numbers">
                        <button class="math-key num" onclick="insertMath('7')">7</button>
                        <button class="math-key num" onclick="insertMath('8')">8</button>
                        <button class="math-key num" onclick="insertMath('9')">9</button>
                        <button class="math-key num" onclick="insertMath('4')">4</button>
                        <button class="math-key num" onclick="insertMath('5')">5</button>
                        <button class="math-key num" onclick="insertMath('6')">6</button>
                        <button class="math-key num" onclick="insertMath('1')">1</button>
                        <button class="math-key num" onclick="insertMath('2')">2</button>
                        <button class="math-key num" onclick="insertMath('3')">3</button>
                        <button class="math-key num wide" onclick="insertMath('0')">0</button>
                        <button class="math-key num" onclick="insertMath('.')">.</button>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn" onclick="checkAnswer()">í™•ì¸</button>
                    <button class="btn" onclick="skipProblem()">ê±´ë„ˆë›°ê¸°</button>
                    <button class="btn" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘</button>
                </div>

                <div class="feedback" id="feedback"></div>
            </div>
        </div>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div class="result-screen" id="resultScreen">
            <h2>ê²Œì„ ì¢…ë£Œ!</h2>
            <div class="result-stats">
                <p>ì •ë‹µ: <span id="finalCorrect">0</span>ê°œ</p>
                <p>ì˜¤ë‹µ: <span id="finalWrong">0</span>ê°œ</p>
                <p id="recordMessage"></p>
            </div>
            
            <div class="leaderboard">
                <h3>ğŸ† ìµœê³  ê¸°ë¡ TOP 5</h3>
                <div id="leaderboardList"></div>
            </div>

            <button class="btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>

        <!-- AI ëª¨ë“œ -->
        <div class="ai-area">
            <div class="difficulty-selector">
                <label for="difficulty">ë‚œì´ë„:</label>
                <select id="difficulty">
                    <option value="easy">ì‰¬ì›€ (ê¸°ë³¸ ê³±ì…ˆê³µì‹)</option>
                    <option value="hard">ì–´ë ¤ì›€ (ë³µì¡í•œ ì¸ìˆ˜ë¶„í•´)</option>
                </select>
            </div>

            <div class="problem-display" id="aiProblemDisplay">
                ë¬¸ì œë¥¼ ìƒì„±í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
            </div>

            <div class="input-group">
                <label for="aiAnswerInput">ì •ë‹µ ì…ë ¥:</label>
                <input type="text" id="aiAnswerInput" placeholder="ì˜ˆ: (x+3)(x-3)">
            </div>

            <!-- ìˆ˜í•™ í‚¤ë³´ë“œ -->
            <div class="math-keyboard">
                <!-- ë³€ìˆ˜ ì„¹ì…˜ -->
                <div class="keyboard-section variables">
                    <button class="math-key var" onclick="insertMathAI('a')">a</button>
                    <button class="math-key var" onclick="insertMathAI('b')">b</button>
                    <button class="math-key var" onclick="insertMathAI('c')">c</button>
                    <button class="math-key var" onclick="insertMathAI('d')">d</button>
                    <button class="math-key var" onclick="insertMathAI('m')">m</button>
                    <button class="math-key var" onclick="insertMathAI('n')">n</button>
                    <button class="math-key var" onclick="insertMathAI('x')">x</button>
                    <button class="math-key var" onclick="insertMathAI('y')">y</button>
                    <button class="math-key var" onclick="insertMathAI('z')">z</button>
                </div>

                <!-- íŠ¹ìˆ˜ ê¸°í˜¸ ì„¹ì…˜ -->
                <div class="keyboard-section special">
                    <button class="math-key special" onclick="insertMathAI('Â²')">xÂ²</button>
                    <button class="math-key special" onclick="insertMathAI('Â³')">xÂ³</button>
                    <button class="math-key special" onclick="insertMathAI('â´')">xâ´</button>
                    <button class="math-key special" onclick="insertMathAI('(')">(</button>
                    <button class="math-key special" onclick="insertMathAI(')')">)</button>
                    <button class="math-key special" onclick="insertMathAI('{')">{</button>
                    <button class="math-key special" onclick="insertMathAI('}')">}</button>
                    <button class="math-key special wide" onclick="backspaceMathAI()">âŒ« ì§€ìš°ê¸°</button>
                </div>

                <!-- ì—°ì‚°ì ì„¹ì…˜ -->
                <div class="keyboard-section operators">
                    <button class="math-key op" onclick="insertMathAI('+')">+</button>
                    <button class="math-key op" onclick="insertMathAI('-')">-</button>
                    <button class="math-key op" onclick="insertMathAI('Ã—')">Ã—</button>
                    <button class="math-key op" onclick="insertMathAI('Ã·')">Ã·</button>
                    <button class="math-key op" onclick="insertMathAI('=')">=</button>
                    <button class="math-key op" onclick="insertMathAI('â‰ ')">â‰ </button>
                </div>

                <!-- ìˆ«ì í‚¤íŒ¨ë“œ -->
                <div class="keyboard-section numbers">
                    <button class="math-key num" onclick="insertMathAI('7')">7</button>
                    <button class="math-key num" onclick="insertMathAI('8')">8</button>
                    <button class="math-key num" onclick="insertMathAI('9')">9</button>
                    <button class="math-key num" onclick="insertMathAI('4')">4</button>
                    <button class="math-key num" onclick="insertMathAI('5')">5</button>
                    <button class="math-key num" onclick="insertMathAI('6')">6</button>
                    <button class="math-key num" onclick="insertMathAI('1')">1</button>
                    <button class="math-key num" onclick="insertMathAI('2')">2</button>
                    <button class="math-key num" onclick="insertMathAI('3')">3</button>
                    <button class="math-key num wide" onclick="insertMathAI('0')">0</button>
                    <button class="math-key num" onclick="insertMathAI('.')">.</button>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="generateAIProblem()">ìƒˆ ë¬¸ì œ</button>
                <button class="btn" onclick="checkAIAnswer()">í™•ì¸</button>
            </div>

            <div class="feedback" id="aiFeedback"></div>

            <div class="ai-comment" id="aiComment">
                AI ì½”ë©˜íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
            </div>
        </div>
    </div>

    <script>
        // ===== API í‚¤ ì„¤ì • =====
        
        
        // ê³±ì…ˆê³µì‹ ë°ì´í„°ë² ì´ìŠ¤
        const formulas = [
            // (a+b)^2 = a^2 + 2ab + b^2
            { factored: '(x+3)Â²', expanded: 'xÂ²+6x+9' },
            { factored: '(x+5)Â²', expanded: 'xÂ²+10x+25' },
            { factored: '(2x+1)Â²', expanded: '4xÂ²+4x+1' },
            
            // (a-b)^2 = a^2 - 2ab + b^2
            { factored: '(x-3)Â²', expanded: 'xÂ²-6x+9' },
            { factored: '(x-5)Â²', expanded: 'xÂ²-10x+25' },
            { factored: '(2x-3)Â²', expanded: '4xÂ²-12x+9' },
            
            // (a+b)(a-b) = a^2 - b^2
            { factored: '(x+4)(x-4)', expanded: 'xÂ²-16' },
            { factored: '(x+7)(x-7)', expanded: 'xÂ²-49' },
            { factored: '(2x+5)(2x-5)', expanded: '4xÂ²-25' },
            { factored: '(3x+2)(3x-2)', expanded: '9xÂ²-4' },
            
            // (x+a)(x+b) = x^2 + (a+b)x + ab
            { factored: '(x+2)(x+3)', expanded: 'xÂ²+5x+6' },
            { factored: '(x+1)(x+6)', expanded: 'xÂ²+7x+6' },
            { factored: '(x-2)(x-5)', expanded: 'xÂ²-7x+10' },
            { factored: '(x+4)(x-3)', expanded: 'xÂ²+x-12' },
        ];

        // ê²Œì„ ìƒíƒœ
        let currentProblem = null;
        let usedProblems = [];
        let correctCount = 0;
        let wrongCount = 0;
        let currentMode = 'game';
        let currentAIProblem = null;
        
        // íƒ€ì´ë¨¸ ê´€ë ¨
        let gameTimer = null;
        let timeLeft = 60;
        let gameInProgress = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            loadLeaderboard();
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameScreen').classList.add('hidden');
        };

        // ê²Œì„ ì‹œì‘
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('hidden');
            newGame();
        }

        // ê²Œì„ ë¦¬ì…‹ (ì‹œì‘ í™”ë©´ìœ¼ë¡œ)
        function resetGame() {
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            gameInProgress = false;
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('startScreen').style.display = 'block';
        }

        // ìˆ˜í•™ í‚¤ë³´ë“œ - ê²Œì„ ëª¨ë“œ
        function insertMath(char) {
            const input = document.getElementById('answerInput');
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(input.selectionEnd);
            
            input.value = textBefore + char + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + char.length, cursorPos + char.length);
        }

        function backspaceMath() {
            const input = document.getElementById('answerInput');
            const cursorPos = input.selectionStart;
            
            if (cursorPos > 0) {
                const textBefore = input.value.substring(0, cursorPos - 1);
                const textAfter = input.value.substring(input.selectionEnd);
                input.value = textBefore + textAfter;
                input.focus();
                input.setSelectionRange(cursorPos - 1, cursorPos - 1);
            }
        }

        // ìˆ˜í•™ í‚¤ë³´ë“œ - AI ëª¨ë“œ
        function insertMathAI(char) {
            const input = document.getElementById('aiAnswerInput');
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(input.selectionEnd);
            
            input.value = textBefore + char + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + char.length, cursorPos + char.length);
        }

        function backspaceMathAI() {
            const input = document.getElementById('aiAnswerInput');
            const cursorPos = input.selectionStart;
            
            if (cursorPos > 0) {
                const textBefore = input.value.substring(0, cursorPos - 1);
                const textAfter = input.value.substring(input.selectionEnd);
                input.value = textBefore + textAfter;
                input.focus();
                input.setSelectionRange(cursorPos - 1, cursorPos - 1);
            }
        }

        // ëª¨ë“œ ì „í™˜
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelector('.game-area').classList.toggle('active', mode === 'game');
            document.querySelector('.ai-area').classList.toggle('active', mode === 'ai');
            document.getElementById('resultScreen').classList.remove('active');
            
            if (mode === 'game') {
                if (gameTimer) {
                    clearInterval(gameTimer);
                }
                gameInProgress = false;
                document.getElementById('startScreen').style.display = 'block';
                document.getElementById('gameScreen').classList.add('hidden');
            }
        }

        // ìƒˆ ê²Œì„ ì‹œì‘
        function newGame() {
            usedProblems = [];
            correctCount = 0;
            wrongCount = 0;
            timeLeft = 60;
            gameInProgress = true;
            
            updateScore();
            updateTimer();
            generateProblem();
            
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            document.getElementById('timeLeft').textContent = timeLeft;
            
            if (timeLeft <= 10) {
                timerDisplay.classList.add('warning');
            } else {
                timerDisplay.classList.remove('warning');
            }
        }

        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            gameInProgress = false;
            clearInterval(gameTimer);
            
            document.getElementById('finalCorrect').textContent = correctCount;
            document.getElementById('finalWrong').textContent = wrongCount;
            
            const isNewRecord = updateLeaderboard(correctCount);
            const recordMsg = document.getElementById('recordMessage');
            
            if (isNewRecord) {
                recordMsg.innerHTML = '<strong style="color: #f39c12;">ğŸ‰ ìƒˆë¡œìš´ ìµœê³  ê¸°ë¡ì…ë‹ˆë‹¤!</strong>';
            } else {
                recordMsg.textContent = '';
            }
            
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('active');
            
            displayLeaderboard();
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            document.getElementById('resultScreen').classList.remove('active');
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameScreen').classList.add('hidden');
            document.querySelector('.game-area').classList.add('active');
        }

        // ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadLeaderboard() {
            const saved = localStorage.getItem('leaderboard');
            return saved ? JSON.parse(saved) : [];
        }

        // ë¦¬ë”ë³´ë“œ ì €ì¥
        function saveLeaderboard(leaderboard) {
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        }

        // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
        function updateLeaderboard(score) {
            let leaderboard = loadLeaderboard();
            const now = new Date();
            const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            leaderboard.push({
                score: score,
                date: dateStr,
                timestamp: now.getTime()
            });
            
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 5);
            
            saveLeaderboard(leaderboard);
            
            return leaderboard[0].timestamp === now.getTime();
        }

        // ë¦¬ë”ë³´ë“œ í‘œì‹œ
        function displayLeaderboard() {
            const leaderboard = loadLeaderboard();
            const listDiv = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; opacity: 0.6;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            listDiv.innerHTML = leaderboard.map((record, index) => {
                const isCurrent = record.score === correctCount && index === 0;
                return `<div class="leaderboard-item ${isCurrent ? 'current' : ''}">
                    ${index + 1}ìœ„. ${record.score}ê°œ (${record.date})
                </div>`;
            }).join('');
        }

        // ë¬¸ì œ ìƒì„±
        function generateProblem() {
            if (!gameInProgress) return;
            
            if (usedProblems.length === formulas.length) {
                usedProblems = [];
            }

            let availableProblems = formulas.filter((_, index) => !usedProblems.includes(index));
            let randomIndex = Math.floor(Math.random() * availableProblems.length);
            let selectedProblem = availableProblems[randomIndex];
            
            let originalIndex = formulas.indexOf(selectedProblem);
            usedProblems.push(originalIndex);

            let problemType = Math.random() < 0.5 ? 'expand' : 'factor';
            
            currentProblem = {
                type: problemType,
                formula: selectedProblem,
                question: problemType === 'expand' ? selectedProblem.factored : selectedProblem.expanded,
                answer: problemType === 'expand' ? selectedProblem.expanded : selectedProblem.factored
            };

            displayProblem();
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').style.display = 'none';
        }

        // ë¬¸ì œ í‘œì‹œ
        function displayProblem() {
            document.getElementById('problemDisplay').innerHTML = `<strong>${currentProblem.question}</strong>`;
        }

        // ë‹µì•ˆ ì •ê·œí™”
        function normalizeAnswer(answer) {
            return answer.replace(/\s+/g, '').toLowerCase()
                .replace(/\*\*/g, '^')
                .replace(/\*/g, '')
                .replace(/\^2/g, 'Â²');
        }

        // ë‹µ í™•ì¸
        function checkAnswer() {
            if (!gameInProgress) return;
            
            const userAnswer = document.getElementById('answerInput').value;
            const normalizedUser = normalizeAnswer(userAnswer);
            const normalizedCorrect = normalizeAnswer(currentProblem.answer);

            const feedbackDiv = document.getElementById('feedback');
            const problemDisplay = document.getElementById('problemDisplay');
            
            if (normalizedUser === normalizedCorrect) {
                problemDisplay.classList.remove('wrong');
                problemDisplay.classList.add('correct');
                
                feedbackDiv.className = 'feedback correct';
                feedbackDiv.textContent = 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰';
                correctCount++;
                updateScore();
                
                setTimeout(() => {
                    problemDisplay.classList.remove('correct');
                    generateProblem();
                }, 500);
            } else {
                problemDisplay.classList.remove('correct');
                problemDisplay.classList.add('wrong');
                
                feedbackDiv.className = 'feedback wrong';
                feedbackDiv.textContent = `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${currentProblem.answer}`;
                wrongCount++;
                updateScore();
                
                setTimeout(() => {
                    problemDisplay.classList.remove('wrong');
                }, 500);
                
                setTimeout(() => {
                    generateProblem();
                }, 2000);
            }
        }

        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateScore() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
        }

        // ë¬¸ì œ ê±´ë„ˆë›°ê¸°
        function skipProblem() {
            if (gameInProgress) {
                generateProblem();
            }
        }

        // Enter í‚¤ ì²˜ë¦¬
        document.getElementById('answerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        document.getElementById('aiAnswerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAIAnswer();
            }
        });

        // AI ë¬¸ì œ ìƒì„±
        async function generateAIProblem() {
            const difficulty = document.getElementById('difficulty').value;
            const problemDisplay = document.getElementById('aiProblemDisplay');
            
            problemDisplay.innerHTML = 'ë¬¸ì œ ìƒì„± ì¤‘...';

            try {
                const prompt = difficulty === 'easy' 
                    ? 'ê³±ì…ˆê³µì‹ì˜ í˜•íƒœê°€ ëª…í™•í•œ ì¸ìˆ˜ë¶„í•´ ë¬¸ì œë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ì„¸ìš”. xì— ëŒ€í•œ 2ì°¨ì‹ì´ì–´ì•¼ í•˜ë©°, (a+b)^2, (a-b)^2, (a+b)(a-b) í˜•íƒœì˜ ê³±ì…ˆê³µì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë¬¸ì œë§Œ ê°„ë‹¨íˆ ì œì‹œí•˜ì„¸ìš”. ì˜ˆ: xÂ²+6x+9 ì•„ë¬´ í…ìŠ¤íŠ¸ ì—†ì´ ë¬¸ì œë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. $ì™€ ^ê°™ì€ ë¬¸ìëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  ì œê³±ê¸°í˜¸ëŠ” ìœ„ì²¨ìë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”. x,y,z,a,b ë“±ì˜ ì•ŒíŒŒë²³ ê¸°í˜¸ëŠ” ìˆ˜í•™ì—ì„œ ë‚˜ì˜¤ëŠ” ëª¨ì–‘ì˜ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.'
                    : 'ë³µì¡í•œ ì¸ìˆ˜ë¶„í•´ ë¬¸ì œë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ì„¸ìš”. í•­ì„ ë¶„ë¦¬í•˜ê±°ë‚˜ ì¬ë°°ì¹˜í•´ì•¼ ê³±ì…ˆê³µì‹ì„ ì ìš©í•  ìˆ˜ ìˆëŠ” í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤. ë¬¸ì œë§Œ ê°„ë‹¨íˆ ì œì‹œí•˜ì„¸ìš”. ì˜ˆ: 4xÂ²+12x+9-yÂ². ì•„ë¬´ í…ìŠ¤íŠ¸ ì—†ì´ ë¬¸ì œë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. $ì™€ ^ê°™ì€ ë¬¸ìëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  ì œê³±ê¸°í˜¸ëŠ” ìœ„ì²¨ìë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”. x,y,z,a,b ë“±ì˜ ì•ŒíŒŒë²³ ê¸°í˜¸ëŠ” ìˆ˜í•™ì—ì„œ ë‚˜ì˜¤ëŠ” ëª¨ì–‘ì˜ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.';

                const response = await fetch("/api/gemini", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    type: "generate",
                    prompt: prompt
                })
                });


                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();

                // ì„œë²„(api/gemini.js)ì—ì„œ ì´ë¯¸ ê°€ê³µëœ text
                const problemText = data.text.trim();

                currentAIProblem = {
                problem: problemText,
                difficulty: difficulty
                };

                problemDisplay.innerHTML = `<strong>${problemText}</strong>`;

                document.getElementById('aiAnswerInput').value = '';
                document.getElementById('aiFeedback').style.display = 'none';
                document.getElementById('aiComment').innerHTML = 'AI ì½”ë©˜íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
            } catch (error) {
                problemDisplay.innerHTML = `ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: ${error.message}`;
                console.error('Error:', error);
            }
        }

        // AI ë‹µì•ˆ í™•ì¸
        async function checkAIAnswer() {
            if (!currentAIProblem) {
                alert('ë¨¼ì € ë¬¸ì œë¥¼ ìƒì„±í•˜ì„¸ìš”!');
                return;
            }

            const userAnswer = document.getElementById('aiAnswerInput').value.trim();
            if (!userAnswer) {
                alert('ë‹µì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            const commentDiv = document.getElementById('aiComment');
            commentDiv.classList.add('loading');
            commentDiv.innerHTML = 'AIê°€ ë‹µì•ˆì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            try {
                const prompt = `ë‹¤ìŒ ì¸ìˆ˜ë¶„í•´ ë¬¸ì œì— ëŒ€í•œ í•™ìƒì˜ ë‹µì„ í‰ê°€í•˜ê³  í”¼ë“œë°±ì„ ì£¼ì„¸ìš”. ë‹¨, ($,^ ë“±ì˜ ê¸°í˜¸ë¥¼ ì“°ì§€ë§ê³ , ì œê³±ì€ ìœ„ì²¨ì ì œê³±ê¸°í˜¸ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.)
()
ë¬¸ì œ: ${currentAIProblem.problem}
í•™ìƒì˜ ë‹µ: ${userAnswer}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”:
1. ì •ë‹µ ì—¬ë¶€ (ë§ìŒ/í‹€ë¦¼)
2. ì •í™•í•œ ë‹µ
3. í˜„ì¬ ë¬¸ì œì˜ ìœ í˜• 

ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

                const response = await fetch("/api/gemini", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    type: "check",
                    prompt: prompt
                })
                });


                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();

                // ì„œë²„ì—ì„œ ì •ë¦¬ëœ Gemini ì‘ë‹µ
                const aiResponse = data.text;

                commentDiv.innerHTML = aiResponse.replace(/\n/g, '<br>');


                const feedbackDiv = document.getElementById('aiFeedback');
                if (aiResponse.includes('ë§ìŒ') || aiResponse.includes('ì •ë‹µ')) {
                    feedbackDiv.className = 'feedback correct';
                    feedbackDiv.textContent = 'ì˜í–ˆìŠµë‹ˆë‹¤! âœ“';
                } else {
                    feedbackDiv.className = 'feedback wrong';
                    feedbackDiv.textContent = 'ë‹¤ì‹œ í•œ ë²ˆ ì‹œë„í•´ë³´ì„¸ìš”.';
                }
            } catch (error) {
                commentDiv.classList.remove('loading');
                commentDiv.innerHTML = `AI ì‘ë‹µ ì‹¤íŒ¨: ${error.message}`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>